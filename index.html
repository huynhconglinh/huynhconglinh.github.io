<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nh·∫≠t k√Ω ghi ch√∫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f7f7; }
    .sidebar-custom {
      background: #f1f4f8;
      border-right: 1px solid #e0e0e0;
      min-height: 100vh;
    }
    .sidebar-actions { margin-top: 2rem; }
    .main-custom { background: #fff; min-height: 100vh; }
    .note-item { background: #f1f8ff; border-radius: 0; padding: 1rem 1.2rem 2.2rem 1.2rem; margin-bottom: 1.2rem; box-shadow: 0 1px 4px #0001; position: relative; }
    .note-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; }
    .note-time { position: absolute; right: 18px; bottom: 8px; font-size: 12px; color: #888; text-align: right; }
    .yt-history-link { cursor: pointer; color: #0d6efd; padding: 4px 0; border-bottom: 1px dashed #e0e0e0; font-size: 15px; transition: color 0.18s; word-break: break-all; }
    .yt-history-link:hover { color: #e74c3c; text-decoration: underline; }
    .youtube-aspect { aspect-ratio: 16/9; width: 100%; max-width: 1000px; margin: 0 auto; background: #000; border-radius: 0; overflow: hidden; position: relative; }
    .youtube-aspect iframe { width: 100%; height: 100%; border: none; display: block; border-radius: 0; background: #000; position: absolute; top: 0; left: 0; }
    .footer-bar { width: 100%; background: #fff; box-shadow: 0 -2px 8px #0001; display: flex; align-items: center; justify-content: center; position: fixed; bottom: 0; left: 0; z-index: 20; min-height: 44px; font-size: 15px; color: #888; letter-spacing: 0.2px; background: #f8fafd; }
    .header-logo { font-weight: bold; font-size: 20px; color: #3498db; letter-spacing: 1px; padding-left: 18px; }
    .note-content { white-space: pre-line; }
    @media (max-width: 900px) {
      .sidebar-custom, .main-custom, .right-custom { min-height: unset; }
    }
    .lang-dropdown {
      min-width: 120px;
    }
    #youtubeHistory {
      max-height: 350px;
      overflow-y: auto;
      padding-bottom: 24px;
    }
    /* Remove border-radius for all UI elements */
    .btn,
    .dropdown-menu,
    .nav-tabs .nav-link,
    .form-control,
    .list-group,
    .list-group-item,
    .badge,
    .card,
    label,
    input,
    textarea {
        border-radius: 0 !important;
        white-space: nowrap;
    }
    .alert {
        border-radius: 0 !important;
    }
    .list-group-item.active {
        background-color: #f8f9fa !important;
        color: #222 !important;
        border-color: #dee2e6 !important;
    }
    .list-group-item.active .badge {
        background: #222 !important;
        color: #fff !important;
    }
    .note-actions,
    .d-flex.gap-1,
    .d-flex.gap-2 {
        flex-wrap: wrap;
    }
    .main-custom,
    .container-fluid.py-4,
    .container-fluid.px-4,
    .container-fluid.py-4.px-4 {
      padding-bottom: 70px !important;
    }
    /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ cho c·ªôt English Definitions v√† See Also trong JPDict */
    .small-text {
      font-size: 0.7em !important;
      word-break: break-all;
    }
    /* JPDict table header custom style */
    .jpdict-header > th {
      background: #e3f0fa !important;
      color: #1a3c5a;
      text-align: center !important;
      vertical-align: middle !important;
      font-weight: 600;
      font-size: 1.05em;
      border-bottom: 2px solid #b6d4ef !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="z-index: 100;">
    <div class="container-fluid">
      <span class="navbar-brand header-logo">hclinh</span>
      <ul class="nav nav-tabs ms-auto me-2" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tabNotes" data-bs-toggle="tab" data-bs-target="#notesTab" type="button" role="tab" data-lang="notes">Log</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tabCommand" data-bs-toggle="tab" data-bs-target="#commandTab" type="button" role="tab" data-lang="command">Note</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tabJPWord" data-bs-toggle="tab" data-bs-target="#jpwordTab" type="button" role="tab" data-lang="jpdict">JPDict</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tabYoutube" data-bs-toggle="tab" data-bs-target="#youtubeTab" type="button" role="tab" data-lang="youtube">YouTube</button>
        </li>
      </ul>
      <div class="dropdown lang-dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          üåê <span id="currentLang">Ti·∫øng Vi·ªát</span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="langDropdown">
          <li><a class="dropdown-item" href="#" onclick="setLang('vi')">Ti·∫øng Vi·ªát</a></li>
          <li><a class="dropdown-item" href="#" onclick="setLang('en')">English</a></li>
          <li><a class="dropdown-item" href="#" onclick="setLang('ja')">Êó•Êú¨Ë™û</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade show active" id="notesTab" role="tabpanel">
      <div class="container-fluid px-4">
        <div class="row g-0">
          <aside class="col-12 col-md-3 sidebar-custom p-3">
            <div class="sidebar-actions d-flex gap-2 mb-3">
              <button class="btn btn-primary flex-fill" onclick="saveToFile()" data-lang="saveFile">L∆∞u</button>
              <label class="btn btn-success flex-fill" for="fileInputTop" tabindex="0" style="margin-bottom:0;" data-lang="loadFile">T·∫£i</label>
              <input type="file" id="fileInputTop" accept=".json" onchange="loadFromFile(event)" style="display:none;">
            </div>
            <ul class="list-group mb-3" id="dayList" style="border-radius:0;"></ul>
            <div class="sidebar-actions d-flex gap-2">
              <button class="btn btn-primary flex-fill" onclick="saveToFile()" data-lang="saveFile">L∆∞u</button>
              <label class="btn btn-success flex-fill" for="fileInput" tabindex="0" style="margin-bottom:0;" data-lang="loadFile">T·∫£i</label>
              <input type="file" id="fileInput" accept=".json" onchange="loadFromFile(event)" style="display:none;">
            </div>
          </aside>
          <main class="col-12 col-md-6 main-custom p-4">
            <div class="notes-list" id="notesList"></div>
          </main>
          <aside class="col-12 col-md-3 right-custom bg-light p-3">
            <form class="note-form" id="noteForm" onsubmit="return addOrUpdateNote()">
              <div class="mb-2">
                <input type="text" id="title" class="form-control mb-2" placeholder="Ti√™u ƒë·ªÅ" required data-lang-placeholder="title" />
                <label for="noteDate" class="form-label" data-lang="date" style="display:none"></label>
                <input type="date" id="noteDate" class="form-control mb-2" required />
                <div class="toolbar mb-2 d-flex gap-1">
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="In ƒë·∫≠m" onclick="insertMarkdown('bold')" data-lang-title="bold"><b>B</b></button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="In nghi√™ng" onclick="insertMarkdown('italic')" data-lang-title="italic"><i>I</i></button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="G·∫°ch ngang" onclick="insertMarkdown('strike')" data-lang-title="strike"><s>S</s></button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="Ti√™u ƒë·ªÅ l·ªõn" onclick="insertMarkdown('h1')" data-lang-title="h1">H1</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="Danh s√°ch" onclick="insertMarkdown('ul')" data-lang-title="ul">‚Ä¢</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="Danh s√°ch s·ªë" onclick="insertMarkdown('ol')" data-lang-title="ol">1.</button>
                </div>
                <textarea id="content" class="form-control mb-2" placeholder="N·ªôi dung ghi ch√∫..." required data-lang-placeholder="content"></textarea>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="plaintextCheckbox" checked>
                  <label class="form-check-label" for="plaintextCheckbox">Plaintext</label>
                </div>
                <input type="hidden" id="editIndex" value="" />
                <div class="d-flex justify-content-end gap-2">
                  <button type="submit" id="addBtn" class="btn btn-primary" data-lang="addNote">Th√™m ghi ch√∫</button>
                  <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display:none;" onclick="cancelEdit()" data-lang="cancelEdit">Hu·ª∑ s·ª≠a</button>
                </div>
              </div>
            </form>
          </aside>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="youtubeTab" role="tabpanel">
      <div class="container-fluid py-4">
        <div style="max-width:1000px;margin:0 auto;">
          <form onsubmit="return showYoutubeVideo()" class="row g-2 align-items-center mb-3">
            <div class="col-auto">
              <button type="submit" class="btn btn-danger" data-lang="view">Xem</button>
            </div>
            <div class="col">
              <input type="url" id="youtubeLink" class="form-control" placeholder="D√°n link YouTube..." required data-lang-placeholder="youtubePlaceholder" />
            </div>
          </form>
          <div id="youtubePlayer" class="mb-3"></div>
          <div id="youtubeHistory" class="youtube-history"></div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="commandTab" role="tabpanel">
      <div class="container-fluid py-4 px-4">
        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" onclick="saveCommandsToFile()" data-lang="saveCmdFile">L∆∞u command ra file</button>
            <label class="btn btn-success" for="commandFileInputTop" tabindex="0" style="margin-bottom:0;" data-lang="loadCmdFile">T·∫£i file command l√™n</label>
            <input type="file" id="commandFileInputTop" accept=".json" onchange="loadCommandsFromFile(event)" style="display:none;">
        </div>
        <div class="mb-3">
            <input type="text" id="commandSearchInput" class="form-control" placeholder="T√¨m ki·∫øm command..." oninput="renderCommandLines()" />
        </div>
        <table class="table table-bordered align-middle mb-0" id="commandTable">
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th style="width:180px" data-lang="commandTitle">Title</th>
              <th data-lang="commandLine">Command Line</th>
              <th data-lang="actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr id="commandInputRow">
              <td>0</td>
              <td><input type="text" id="commandTitleInput" class="form-control" placeholder="Title..." data-lang-placeholder="commandTitleInput" /></td>
              <td><input type="text" id="commandInput" class="form-control" placeholder="Command line..." data-lang-placeholder="commandInput" /></td>
              <td>
                <button class="btn btn-primary btn-sm" id="addCommandBtn" data-lang="add">Add</button>
              </td>
            </tr>
            <!-- C√°c d√≤ng command s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y b·∫±ng JS -->
          </tbody>
        </table>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary" onclick="saveCommandsToFile()" data-lang="saveCmdFile">L∆∞u command ra file</button>
          <label class="btn btn-success" for="commandFileInputBottom" tabindex="0" style="margin-bottom:0;" data-lang="loadCmdFile">T·∫£i file command l√™n</label>
          <input type="file" id="commandFileInputBottom" accept=".json" onchange="loadCommandsFromFile(event)" style="display:none;">
        </div>
        <div id="commandSearchResult"></div>
      </div>
    </div>
    <div class="tab-pane fade" id="jpwordTab" role="tabpanel">
      <div class="container-fluid py-4 px-4">
        <div class="d-flex gap-2 mb-3 align-items-center">
          <button class="btn btn-primary" onclick="saveJPDictToFile()" data-lang="jpdict_save">L∆∞u</button>
          <label class="btn btn-success" for="jpdictFileInput" tabindex="0" style="margin-bottom:0;" data-lang="jpdict_load">T·∫£i</label>
          <input type="file" id="jpdictFileInput" accept=".json" onchange="loadJPDictFromFile(event)" style="display:none;">
          <span class="text-danger small ms-2" style="white-space:normal;max-width:320px;" data-lang="jpdict_cors_hint"></span>
        </div>
        <form id="jpwordForm" class="row g-2 align-items-center mb-3" onsubmit="return fetchJPWord()">
          <div class="col-auto">
            <button type="submit" class="btn btn-warning" data-lang="jpdict_search">Tra c·ª©u</button>
          </div>
          <div class="col">
            <input type="text" id="jpwordInput" class="form-control" placeholder="Nh·∫≠p t·ª´ v·ª±ng ti·∫øng Nh·∫≠t..." required data-lang-placeholder="jpdict_placeholder" />
          </div>
        </form>
        <div id="jpwordStatus"></div>
        <div class="mb-3">
          <input type="text" id="jpdictSearchInput" class="form-control" data-lang-placeholder="jpdict_search_placeholder" oninput="renderJPWordTable()" />
        </div>
        <div id="jpwordResult"></div>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary" onclick="saveJPDictToFile()" data-lang="jpdict_save">L∆∞u</button>
          <label class="btn btn-success" for="jpdictFileInputBottom" tabindex="0" style="margin-bottom:0;" data-lang="jpdict_load">T·∫£i</label>
          <input type="file" id="jpdictFileInputBottom" accept=".json" onchange="loadJPDictFromFile(event)" style="display:none;">
        </div>
      </div>
    </div>
  </div>
  <div class="footer-bar" data-lang="copyright">
    ¬© 2024 hclinh. All rights reserved.
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    let notes = [];
    let selectedDay = '';
    let youtubeHistory = JSON.parse(localStorage.getItem('youtubeHistory') || '[]');
    let commandLines = [];
    let editingCmdIdx = null;
    let jpwordResults = [];
    let jpwordEditIdx = null;

    // ƒêa ng√¥n ng·ªØ
    const translations = {
      vi: {
        addNote: "L∆∞u",
        updateNote: "C·∫≠p nh·∫≠t",
        cancelEdit: "Hu·ª∑ s·ª≠a",
        title: "Ti√™u ƒë·ªÅ",
        content: "N·ªôi dung ghi ch√∫...",
        date: "Ng√†y t·∫°o",
        saveFile: "L∆∞u",
        loadFile: "T·∫£i",
        noNote: "Ch∆∞a c√≥ ghi ch√∫ n√†o.",
        noNoteDay: "Ch∆∞a c√≥ ghi ch√∫ n√†o cho ng√†y n√†y.",
        edit: "S·ª≠a",
        del: "Xo√°",
        up: "L√™n",
        down: "Xu·ªëng",
        youtube: "YouTube",
        notes: "Log",
        view: "Xem",
        history: "L·ªãch s·ª≠ video ƒë√£ xem:",
        copyright: "¬© 2024 hclinh. All rights reserved.",
        youtubePlaceholder: "D√°n link YouTube...",
        confirmDelete: "B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ghi ch√∫ n√†y?",
        edited: "ƒë√£ s·ª≠a",
        bold: "In ƒë·∫≠m",
        italic: "In nghi√™ng",
        strike: "G·∫°ch ngang",
        h1: "Ti√™u ƒë·ªÅ l·ªõn",
        ul: "Danh s√°ch",
        ol: "Danh s√°ch s·ªë",
        command: "Note",
        commandLine: "Command Line",
        actions: "Thao t√°c",
        add: "Th√™m",
        editCmd: "S·ª≠a",
        delCmd: "Xo√°",
        copy: "Copy",
        commandInput: "Nh·∫≠p command line...",
        saveCmdFile: "L∆∞u",
        loadCmdFile: "T·∫£i",
        commandTitle: "Ti√™u ƒë·ªÅ",
        commandTitleInput: "Nh·∫≠p ti√™u ƒë·ªÅ...",
        save: "L∆∞u",
        jpdict_save: "L∆∞u",
        jpdict_load: "T·∫£i",
        jpdict_word: "T·ª´",
        jpdict_reading: "ƒê·ªçc",
        jpdict_jlpt: "JLPT",
        jpdict_english: "Nghƒ©a Anh",
        jpdict_type: "Lo·∫°i",
        jpdict_seealso: "Xem th√™m",
        jpdict_note: "Ghi ch√∫",
        jpdict_actions: "Thao t√°c",
        jpdict_edit: "S·ª≠a",
        jpdict_delete: "Xo√°",
        jpdict_saveedit: "L∆∞u",
        jpdict_cancel: "Hu·ª∑",
        jpdict_search: "T√¨m ki·∫øm t·ª´ v·ª±ng...",
        jpdict_placeholder: "Nh·∫≠p t·ª´ v·ª±ng ti·∫øng Nh·∫≠t...",
        jpdict_search_placeholder: "T√¨m ki·∫øm t·ª´ v·ª±ng...",
        jpdict_cors_hint: "N·∫øu kh√¥ng th·ªÉ tra c·ª©u, h√£y v√†o <a href=\"https://cors-anywhere.herokuapp.com/corsdemo\" target=\"_blank\">link n√†y</a>, b·∫•m n√∫t c·∫•p quy·ªÅn, r·ªìi quay l·∫°i th·ª≠ l·∫°i t√≠nh nƒÉng tra c·ª©u.",
      },
      en: {
        addNote: "Save",
        updateNote: "Update",
        cancelEdit: "Cancel",
        title: "Title",
        content: "Note content...",
        date: "Date",
        saveFile: "Save",
        loadFile: "Load",
        noNote: "No notes yet.",
        noNoteDay: "No notes for this day.",
        edit: "Edit",
        del: "Delete",
        up: "Up",
        down: "Down",
        youtube: "YouTube",
        notes: "Log",
        view: "View",
        history: "Watched video history:",
        copyright: "¬© 2024 hclinh. All rights reserved.",
        youtubePlaceholder: "Paste YouTube link...",
        confirmDelete: "Are you sure you want to delete this note?",
        edited: "edited",
        bold: "Bold",
        italic: "Italic",
        strike: "Strikethrough",
        h1: "Heading 1",
        ul: "Unordered list",
        ol: "Ordered list",
        command: "Note",
        commandLine: "Command Line",
        actions: "Actions",
        add: "Add",
        editCmd: "Edit",
        delCmd: "Delete",
        copy: "Copy",
        commandInput: "Enter command line...",
        saveCmdFile: "Save",
        loadCmdFile: "Load",
        commandTitle: "Title",
        commandTitleInput: "Enter title...",
        save: "Save",
        jpdict_save: "Save",
        jpdict_load: "Load",
        jpdict_word: "Word",
        jpdict_reading: "Reading",
        jpdict_jlpt: "JLPT",
        jpdict_english: "English Definitions",
        jpdict_type: "Type",
        jpdict_seealso: "See Also",
        jpdict_note: "Note",
        jpdict_actions: "Actions",
        jpdict_edit: "Edit",
        jpdict_delete: "Delete",
        jpdict_saveedit: "Save",
        jpdict_cancel: "Cancel",
        jpdict_search: "Search",
        jpdict: "JPDict",
        jpdict_placeholder: "Enter Japanese word...",
        jpdict_search_placeholder: "Search vocabulary...",
        jpdict_cors_hint: "If you cannot search, please visit <a href=\"https://cors-anywhere.herokuapp.com/corsdemo\" target=\"_blank\">this link</a>, click the request access button, then return and try again.",
      },
      ja: {
        addNote: "‰øùÂ≠ò",
        updateNote: "Êõ¥Êñ∞",
        cancelEdit: "„Ç≠„É£„É≥„Çª„É´",
        title: "„Çø„Ç§„Éà„É´",
        content: "„Éé„Éº„ÉàÂÜÖÂÆπ...",
        date: "Êó•‰ªò",
        saveFile: "‰øùÂ≠ò",
        loadFile: "Ë™≠Ëæº",
        noNote: "„Éé„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
        noNoteDay: "„Åì„ÅÆÊó•„Å´„Éé„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
        edit: "Á∑®ÈõÜ",
        del: "ÂâäÈô§",
        up: "‰∏ä„Å∏",
        down: "‰∏ã„Å∏",
        youtube: "YouTube",
        notes: "„É≠„Ç∞",
        view: "Ë°®Á§∫",
        history: "Ë¶ñËÅ¥Â±•Ê≠¥:",
        copyright: "¬© 2024 hclinh. All rights reserved.",
        youtubePlaceholder: "YouTube„É™„É≥„ÇØ„ÇíË≤º„Çä‰ªò„Åë...",
        confirmDelete: "„Åì„ÅÆ„Éé„Éº„Éà„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
        edited: "Á∑®ÈõÜÊ∏à„Åø",
        bold: "Â§™Â≠ó",
        italic: "Êñú‰Ωì",
        strike: "Âèñ„ÇäÊ∂à„ÅóÁ∑ö",
        h1: "Ë¶ãÂá∫„Åó1",
        ul: "ÁÆáÊù°Êõ∏„Åç",
        ol: "Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà",
        command: "„Éé„Éº„Éà",
        commandLine: "„Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥",
        actions: "Êìç‰Ωú",
        add: "ËøΩÂä†",
        editCmd: "Á∑®ÈõÜ",
        delCmd: "ÂâäÈô§",
        copy: "„Ç≥„Éî„Éº",
        commandInput: "„Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥„ÇíÂÖ•Âäõ...",
        saveCmdFile: "‰øùÂ≠ò",
        loadCmdFile: "Ë™≠Ëæº",
        commandTitle: "„Çø„Ç§„Éà„É´",
        commandTitleInput: "„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ...",
        save: "‰øùÂ≠ò",
        jpdict_save: "‰øùÂ≠ò",
        jpdict_load: "Ë™≠Ëæº",
        jpdict_word: "ÂçòË™û",
        jpdict_reading: "Ë™≠„Åø",
        jpdict_jlpt: "JLPT",
        jpdict_english: "Ëã±Ë™û„ÅÆÂÆöÁæ©",
        jpdict_type: "„Çø„Ç§„Éó",
        jpdict_seealso: "ÂèÇÁÖß",
        jpdict_note: "„É°„É¢",
        jpdict_actions: "Êìç‰Ωú",
        jpdict_edit: "Á∑®ÈõÜ",
        jpdict_delete: "ÂâäÈô§",
        jpdict_saveedit: "‰øùÂ≠ò",
        jpdict_cancel: "„Ç≠„É£„É≥„Çª„É´",
        jpdict_search: "Ê§úÁ¥¢",
        jpdict: "JPDict",
        jpdict_placeholder: "Êó•Êú¨Ë™û„ÅÆÂçòË™û„ÇíÂÖ•Âäõ...",
        jpdict_search_placeholder: "ÂçòË™û„ÇíÊ§úÁ¥¢...",
        jpdict_cors_hint: "Ê§úÁ¥¢„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ<a href=\"https://cors-anywhere.herokuapp.com/corsdemo\" target=\"_blank\">„Åì„ÅÆ„É™„É≥„ÇØ</a>„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„ÄÅË®±ÂèØ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åã„Çâ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
      }
    };
    let currentLang = localStorage.getItem('lang') || 'vi';
    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      updateLang();
    }
    function t(key) { return translations[currentLang][key] || key; }
    function updateLang() {
      // T·ª± ƒë·ªông c·∫≠p nh·∫≠t text/placeholder/title cho m·ªçi ph·∫ßn t·ª≠ c√≥ data-lang, data-lang-placeholder, data-lang-title
      document.querySelectorAll('[data-lang]').forEach(el => {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.placeholder = t(el.getAttribute('data-lang'));
        } else if (el.getAttribute('data-lang') === 'jpdict_cors_hint') {
          el.innerHTML = t('jpdict_cors_hint');
        } else {
          el.textContent = t(el.getAttribute('data-lang'));
        }
      });
      document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
        el.placeholder = t(el.getAttribute('data-lang-placeholder'));
      });
      document.querySelectorAll('[data-lang-title]').forEach(el => {
        el.title = t(el.getAttribute('data-lang-title'));
      });
      // ƒê·∫∑c bi·ªát cho label ng√†y (·∫©n) n·∫øu c√≥
      var dateLabel = document.querySelector('label[for="noteDate"][data-lang="date"]');
      if (dateLabel) dateLabel.textContent = t('date');
      // ƒê·ªïi t√™n ng√¥n ng·ªØ hi·ªán t·∫°i tr√™n dropdown
      document.getElementById('currentLang').textContent =
        currentLang === 'vi' ? 'Ti·∫øng Vi·ªát' : (currentLang === 'en' ? 'English' : 'Êó•Êú¨Ë™û');
      // Ghi ch√∫ v√† sidebar s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi renderNotes/renderDayList
      renderDayList();
      renderNotes();
      renderYoutubeHistory();
      renderCommandLines();
      renderJPWordTable();
      saveToLocal();
    }

    function getDayStr(dateObj) {
      // Tr·∫£ v·ªÅ YYYY-MM-dd
      return dateObj.toISOString().slice(0, 10);
    }

    function groupNotesByDay() {
      const groups = {};
      notes.forEach((note, idx) => {
        const day = note.day || note.date.slice(0, 10);
        if (!groups[day]) groups[day] = [];
        groups[day].push({ ...note, _idx: idx });
      });
      return groups;
    }

    function renderDayList() {
      const dayList = document.getElementById('dayList');
      const groups = groupNotesByDay();
      const days = Object.keys(groups).sort((a, b) => b.localeCompare(a));
      dayList.innerHTML = '';
      if (days.length === 0) {
        dayList.innerHTML = `<li class="list-group-item text-center text-muted">${t('noNote')}</li>`;
        selectedDay = '';
        renderNotes();
        return;
      }
      days.forEach(day => {
        const li = document.createElement('li');
        li.className = 'list-group-item p-2';
        li.style.cursor = 'pointer';
        li.innerHTML = `<div class="d-flex justify-content-between align-items-center">
          <span class="fw-bold">${day}</span>
          <span class="badge bg-light text-dark rounded-pill ms-2">${groups[day].length}</span>
        </div>`;
        // Danh s√°ch ti√™u ƒë·ªÅ ghi ch√∫ n·∫øu ng√†y ƒëang m·ªü
        if (day === selectedDay) {
          const noteTitlesUl = document.createElement('ul');
          noteTitlesUl.className = 'list-group list-group-flush mt-2';
          groups[day].forEach((note, idx) => {
            const noteLi = document.createElement('li');
            noteLi.className = 'list-group-item py-1 px-2';
            noteLi.style.cursor = 'pointer';
            noteLi.style.fontSize = '15px';
            noteLi.innerText = note.title;
            noteLi.title = note.title;
            noteLi.onclick = (e) => {
              e.stopPropagation();
              const noteDiv = document.getElementById('note-' + note._idx);
              if (noteDiv) {
                noteDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                noteDiv.classList.add('border-primary');
                setTimeout(() => noteDiv.classList.remove('border-primary'), 1200);
              }
            };
            noteTitlesUl.appendChild(noteLi);
          });
          li.appendChild(noteTitlesUl);
        }
        li.onclick = () => {
          selectedDay = (selectedDay === day) ? '' : day;
          renderDayList();
          renderNotes();
          cancelEdit();
        };
        if (day === selectedDay) li.classList.add('active');
        dayList.appendChild(li);
      });
      if (!selectedDay && days.length > 0) {
        selectedDay = days[0];
        renderDayList();
        renderNotes();
      }
    }

    function renderNotes() {
      const notesList = document.getElementById('notesList');
      if (!selectedDay) {
        notesList.innerHTML = `<div class="alert alert-secondary">${t('noNote')}</div>`;
        return;
      }
      const groups = groupNotesByDay();
      const dayNotes = groups[selectedDay] || [];
      notesList.innerHTML = '';
      if (dayNotes.length === 0) {
        notesList.innerHTML = `<div class="alert alert-secondary">${t('noNoteDay')}</div>`;
        return;
      }
      dayNotes.forEach((note, idx) => {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'card note-item mb-3';
        noteDiv.id = 'note-' + note._idx;
        let noteContentHtml = '';
        if (note.plaintext !== false) {
            // Plaintext: gi·ªØ nguy√™n format, escape HTML, gi·ªØ breakline
            noteContentHtml = `<div class="note-content" style="white-space:pre-line;">${escapeHTML(note.content)}</div>`;
        } else {
            // Markdown: lo·∫°i b·ªè space ƒë·∫ßu d√≤ng, gi·ªõi h·∫°n d√≤ng tr·∫Øng li√™n ti·∫øp
            let cleanedContent = note.content.split('\n').map(line => line.replace(/^\s+/, '')).join('\n');
            cleanedContent = cleanedContent.replace(/(\n\s*){2,}/g, '\n\n');
            noteContentHtml = `<div class="note-content">${marked.parse(cleanedContent)}</div>`;
        }
        noteDiv.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="fw-bold text-primary">${escapeHTML(note.title)}</div>
              <div class="btn-group btn-group-sm note-actions" role="group">
                <button class="btn btn-warning" onclick="moveNote(${note._idx}, -1)" title="${t('up')}">‚ñ≤</button>
                <button class="btn btn-warning" onclick="moveNote(${note._idx}, 1)" title="${t('down')}">‚ñº</button>
                <button class="btn btn-info text-white" onclick="editNote(${note._idx})">${t('edit')}</button>
                <button class="btn btn-danger" onclick="deleteNote(${note._idx})">${t('del')}</button>
              </div>
            </div>
            ${noteContentHtml}
            <div class="note-time text-end text-muted mt-2" style="font-size:13px;">${note.date}</div>
          </div>
        `;
        notesList.appendChild(noteDiv);
      });
    }

    function addOrUpdateNote() {
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      const noteDate = document.getElementById('noteDate').value;
      const plaintext = document.getElementById('plaintextCheckbox').checked;
      const editIndex = document.getElementById('editIndex').value;
      if (!title || !content || !noteDate) return false;
      const now = new Date();
      const dateStr = now.toLocaleString('vi-VN');
      const dayStr = noteDate;
      if (editIndex === '') {
        // Th√™m m·ªõi
        notes.unshift({ day: dayStr, date: dateStr, title, content, plaintext });
        selectedDay = dayStr;
      } else {
        // S·ª≠a
        notes[editIndex].title = title;
        notes[editIndex].content = content;
        notes[editIndex].date = dateStr + ' (' + t('edited') + ')';
        notes[editIndex].day = dayStr;
        notes[editIndex].plaintext = plaintext;
        selectedDay = notes[editIndex].day;
      }
      renderDayList();
      renderNotes();
      document.getElementById('noteForm').reset();
      document.getElementById('editIndex').value = '';
      document.getElementById('addBtn').textContent = t('addNote');
      document.getElementById('cancelEditBtn').style.display = 'none';
      // ƒê·∫∑t l·∫°i ng√†y v·ªÅ h√¥m nay sau khi th√™m/s·ª≠a (n·∫øu kh√¥ng ph·∫£i ƒëang edit)
      if (!document.getElementById('editIndex').value) {
        document.getElementById('noteDate').value = (new Date()).toISOString().slice(0, 10);
        document.getElementById('plaintextCheckbox').checked = true;
      }
      saveToLocal();
      return false;
    }

    function editNote(idx) {
      const note = notes[idx];
      document.getElementById('title').value = note.title;
      document.getElementById('content').value = note.content;
      document.getElementById('editIndex').value = idx;
      document.getElementById('addBtn').textContent = t('updateNote');
      document.getElementById('cancelEditBtn').style.display = '';
      document.getElementById('noteDate').value = note.day || (new Date()).toISOString().slice(0, 10);
      document.getElementById('plaintextCheckbox').checked = note.plaintext !== false;
    }

    function cancelEdit() {
      document.getElementById('noteForm').reset();
      document.getElementById('editIndex').value = '';
      document.getElementById('addBtn').textContent = t('addNote');
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('noteDate').value = (new Date()).toISOString().slice(0, 10);
      document.getElementById('plaintextCheckbox').checked = true;
    }

    function deleteNote(idx) {
      if (confirm(t('confirmDelete'))) {
        notes.splice(idx, 1);
        renderDayList();
        renderNotes();
        cancelEdit();
        saveToLocal();
      }
    }

    function saveToFile() {
      const data = { notes, commandLines };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hclinh-log.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            notes = data;
            commandLines = [];
          } else if (typeof data === 'object' && data.notes && data.commandLines) {
            notes = data.notes;
            commandLines = data.commandLines;
          } else {
            alert('File kh√¥ng h·ª£p l·ªá!');
            return;
          }
          renderDayList();
          renderNotes();
          renderCommandLines();
          cancelEdit();
          saveToLocal();
        } catch {
          alert('File kh√¥ng h·ª£p l·ªá!');
        }
      };
      reader.readAsText(file);
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(tag) {
        const chars = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return chars[tag] || tag;
      });
    }

    function insertMarkdown(type) {
      const textarea = document.getElementById('content');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      let before = textarea.value.substring(0, start);
      let after = textarea.value.substring(end);
      let selected = textarea.value.substring(start, end);
      let insertText = '', cursorMove = 0;
      if ((type === 'ul' || type === 'ol') && selected.includes('\n')) {
        // N·∫øu ch·ªçn nhi·ªÅu d√≤ng, √°p d·ª•ng cho t·ª´ng d√≤ng
        const lines = selected.split(/\r?\n/);
        if (type === 'ul') {
          insertText = lines.map(line => line ? `- ${line}` : '').join('\n');
        } else {
          insertText = lines.map((line, idx) => line ? `${idx + 1}. ${line}` : '').join('\n');
        }
        cursorMove = 0;
      } else {
        switch(type) {
          case 'bold':
            insertText = `**${selected || 'ƒë·∫≠m'}**`;
            cursorMove = selected ? 0 : 2;
            break;
          case 'italic':
            insertText = `*${selected || 'nghi√™ng'}*`;
            cursorMove = selected ? 0 : 1;
            break;
          case 'strike':
            insertText = `~~${selected || 'g·∫°ch'}~~`;
            cursorMove = selected ? 0 : 2;
            break;
          case 'h1':
            insertText = `# ${selected || 'Ti√™u ƒë·ªÅ l·ªõn'}`;
            cursorMove = selected ? 0 : 2;
            break;
          case 'ul':
            insertText = `- ${selected || 'G·∫°ch ƒë·∫ßu d√≤ng'}`;
            cursorMove = selected ? 0 : 2;
            break;
          case 'ol':
            insertText = `1. ${selected || 'S·ªë th·ª© t·ª±'}`;
            cursorMove = selected ? 0 : 3;
            break;
        }
      }
      textarea.value = before + insertText + after;
      // ƒê·∫∑t l·∫°i v·ªã tr√≠ con tr·ªè
      const newPos = before.length + insertText.length - cursorMove;
      textarea.focus();
      textarea.setSelectionRange(newPos, newPos);
    }

    function moveNote(idx, direction) {
      // idx l√† index trong m·∫£ng notes (to√†n b·ªô), direction: -1 (up), 1 (down)
      const note = notes[idx];
      // L·ªçc ra c√°c notes c√πng ng√†y
      const day = note.day;
      const dayNotesIdx = notes
        .map((n, i) => ({ n, i }))
        .filter(obj => obj.n.day === day)
        .map(obj => obj.i);
      const pos = dayNotesIdx.indexOf(idx);
      if (pos === -1) return;
      const swapWith = pos + direction;
      if (swapWith < 0 || swapWith >= dayNotesIdx.length) return;
      // ƒê·ªïi ch·ªó trong m·∫£ng notes
      const idx2 = dayNotesIdx[swapWith];
      [notes[idx], notes[idx2]] = [notes[idx2], notes[idx]];
      renderDayList();
      renderNotes();
      saveToLocal();
    }

    function showYoutubeVideo() {
      const link = document.getElementById('youtubeLink').value.trim();
      const playerDiv = document.getElementById('youtubePlayer');
      const videoId = extractYoutubeId(link);
      if (!videoId) {
        playerDiv.innerHTML = '<div style="color:#e74c3c;">Link kh√¥ng h·ª£p l·ªá!</div>';
        return false;
      }
      // Th√™m c√°c tham s·ªë ƒë·ªÉ t·∫Øt qu·∫£ng c√°o
      const embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&iv_load_policy=3&cc_load_policy=0&autoplay=0&controls=1&disablekb=0&fs=1&loop=0&playsinline=1&showinfo=0&start=0&end=0&color=white&theme=light`;
      playerDiv.innerHTML = `<div class='youtube-aspect'><iframe src="${embedUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>`;
      saveYoutubeHistory(link);
      renderYoutubeHistory();
      return false;
    }

    function extractYoutubeId(url) {
      // H·ªó tr·ª£ nhi·ªÅu d·∫°ng link YouTube
      const regExp = /^.*(?:youtu.be\/|v=|u=\w\/|embed\/|shorts\/|watch\?v=|watch\?.+&v=)([^#&?\n\r\s]{11}).*/;
      const match = url.match(regExp);
      return match ? match[1] : null;
    }

    function saveYoutubeHistory(link) {
      if (!youtubeHistory.includes(link)) {
        youtubeHistory.unshift(link);
        if (youtubeHistory.length > 20) youtubeHistory = youtubeHistory.slice(0, 20);
        localStorage.setItem('youtubeHistory', JSON.stringify(youtubeHistory));
      }
    }

    function renderYoutubeHistory() {
      const historyDiv = document.getElementById('youtubeHistory');
      if (!historyDiv) return;
      if (youtubeHistory.length === 0) {
        historyDiv.innerHTML = '';
        return;
      }
      historyDiv.innerHTML = `<div style="font-weight:500;margin:18px 0 6px 0;">${t('history')}</div>` +
        youtubeHistory.map(link => `<div class=\"yt-history-link\" data-link=\"${encodeURIComponent(link)}\">${escapeHTML(link)}</div>`).join('');
      // G√°n s·ª± ki·ªán click cho t·ª´ng link
      Array.from(historyDiv.querySelectorAll('.yt-history-link')).forEach(el => {
        el.onclick = function() {
          playYoutubeHistory(decodeURIComponent(this.getAttribute('data-link')));
        };
      });
    }

    function playYoutubeHistory(link) {
      document.getElementById('youtubeLink').value = link;
      showYoutubeVideo();
    }

    function renderCommandLines() {
      const tbody = document.querySelector('#commandTable tbody');
      // X√≥a c√°c d√≤ng c≈© (tr·ª´ d√≤ng input)
      Array.from(tbody.querySelectorAll('tr')).forEach((tr, i) => { if (tr.id !== 'commandInputRow') tr.remove(); });
      const searchVal = document.getElementById('commandSearchInput')?.value.trim().toLowerCase();
      let filtered = commandLines.map((item, idx) => ({...item, idx}));
      if (searchVal) {
        filtered = filtered.filter(item =>
          (item.title && item.title.toLowerCase().includes(searchVal)) ||
          (item.cmd && item.cmd.toLowerCase().includes(searchVal))
        );
      }
      filtered.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.idx + 1}</td>
          <td>${editingCmdIdx === item.idx ? `<input type='text' class='form-control' value="${escapeHTML(item.title||'')}" id='editCmdTitle${item.idx}' />` : `<span>${escapeHTML(item.title||'')}</span>`}</td>
          <td>${editingCmdIdx === item.idx ? `<input type='text' class='form-control' value="${escapeHTML(item.cmd)}" id='editCmdInput${item.idx}' />` : `<span>${escapeHTML(item.cmd)}</span>`}</td>
          <td class='d-flex gap-1'>
            <button class='btn btn-secondary btn-sm' title='${t('copy')}' onclick='copyCommandLine(${item.idx})'>${t('copy')}</button>
            ${editingCmdIdx === item.idx
              ? `<button class='btn btn-success btn-sm' onclick='saveEditCommandLine(${item.idx})'>${t('save')}</button><button class='btn btn-secondary btn-sm' onclick='cancelEditCommandLine()'>${t('cancelEdit')}</button>`
              : `<button class='btn btn-info btn-sm' onclick='editCommandLine(${item.idx})'>${t('editCmd')}</button>`}
            <button class='btn btn-danger btn-sm' onclick='deleteCommandLine(${item.idx})'>${t('delCmd')}</button>
            <button class='btn btn-warning btn-sm' onclick='moveCommandLine(${item.idx},-1)' ${item.idx===0?'disabled':''}>‚ñ≤</button>
            <button class='btn btn-warning btn-sm' onclick='moveCommandLine(${item.idx},1)' ${item.idx===commandLines.length-1?'disabled':''}>‚ñº</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('addCommandBtn').onclick = function(e) {
      e.preventDefault();
      const title = document.getElementById('commandTitleInput').value.trim();
      const cmd = document.getElementById('commandInput').value.trim();
      if (cmd) {
        commandLines.unshift({ title, cmd });
        document.getElementById('commandTitleInput').value = '';
        document.getElementById('commandInput').value = '';
        renderCommandLines();
        saveToLocal();
      }
    };

    function copyCommandLine(idx) {
      navigator.clipboard.writeText(commandLines[idx].cmd);
    }

    function editCommandLine(idx) {
      editingCmdIdx = idx;
      renderCommandLines();
      setTimeout(()=>{
        document.getElementById('editCmdTitle'+idx).focus();
      },10);
    }

    function saveEditCommandLine(idx) {
      const title = document.getElementById('editCmdTitle'+idx).value.trim();
      const cmd = document.getElementById('editCmdInput'+idx).value.trim();
      if(cmd) commandLines[idx]={ title, cmd };
      editingCmdIdx=null;
      renderCommandLines();
      saveToLocal();
    }

    function cancelEditCommandLine() {
      editingCmdIdx=null;
      renderCommandLines();
    }

    function deleteCommandLine(idx) {
      if(confirm(t('confirmDelete'))) {
        commandLines.splice(idx,1);
        renderCommandLines();
        saveToLocal();
      }
    }

    function moveCommandLine(idx, dir) {
      const newIdx = idx+dir;
      if(newIdx<0||newIdx>=commandLines.length) return;
      [commandLines[idx],commandLines[newIdx]]=[commandLines[newIdx],commandLines[idx]];
      renderCommandLines();
      saveToLocal();
    }

    function saveToLocal() {
      localStorage.setItem('commandLines', JSON.stringify(commandLines));
      localStorage.setItem('notes', JSON.stringify(notes));
    }

    // Load commandLines t·ª´ localStorage khi kh·ªüi t·∫°o
    if(localStorage.getItem('commandLines')) {
      commandLines = JSON.parse(localStorage.getItem('commandLines'));
    }
    if(localStorage.getItem('notes')) {
      notes = JSON.parse(localStorage.getItem('notes'));
    }
    renderCommandLines();
    if (notes && notes.length > 0) {
      renderDayList();
      renderNotes();
    }

    // Kh·ªüi t·∫°o giao di·ªán
    renderDayList();
    renderNotes();
    // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay khi load trang
    document.getElementById('noteDate').value = (new Date()).toISOString().slice(0, 10);
    // ƒê·ªïi ng√¥n ng·ªØ khi load trang
    updateLang();

    function saveCommandsToFile() {
      const blob = new Blob([JSON.stringify(commandLines, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hclinh-note.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadCommandsFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            // N·∫øu l√† m·∫£ng string c≈©, chuy·ªÉn sang object m·ªõi
            if (typeof data[0] === 'string') {
              commandLines = data.map(cmd => ({ title: '', cmd }));
            } else {
              commandLines = data;
            }
            renderCommandLines();
            saveToLocal();
          } else {
            alert('File kh√¥ng h·ª£p l·ªá!');
          }
        } catch {
          alert('File kh√¥ng h·ª£p l·ªá!');
        }
      };
      reader.readAsText(file);
    }

    function fetchJPWord() {
      const word = document.getElementById('jpwordInput').value.trim();
      const statusDiv = document.getElementById('jpwordStatus');
      const resultDiv = document.getElementById('jpwordResult');
      // Ki·ªÉm tra tr√πng t·ª´ (words ho·∫∑c readings)
      const isExist = jpwordResults.some(row => {
        return row.words === word || row.readings === word;
      });
      if (isExist) {
        statusDiv.innerHTML = '<div class="text-warning">T·ª´ n√†y ƒë√£ c√≥ trong b·∫£ng!</div>';
        return false;
      }
      if (!jpwordResults.length) {
        statusDiv.innerHTML = '<div class="text-secondary">ƒêang tra c·ª©u...</div>';
      } else {
        statusDiv.innerHTML = '';
      }
      fetch('https://cors-anywhere.herokuapp.com/https://jisho.org/api/v1/search/words?keyword=' + encodeURIComponent(word))
        .then(res => res.json())
        .then(data => {
          if (!data.data || data.data.length === 0) {
            statusDiv.innerHTML = '<div class="text-danger">Kh√¥ng t√¨m th·∫•y t·ª´ n√†y!</div>';
            return;
          }
          // L·∫•y entry ƒë·∫ßu ti√™n
          const entry = data.data[0];
          const words = entry.japanese.map(j => j.word).filter(Boolean).join(', ');
          const readings = entry.japanese.map(j => j.reading).filter(Boolean).join(', ');
          const jlpt = entry.jlpt && entry.jlpt.length ? entry.jlpt.join(', ') : '';
          const english_definitions = entry.senses.flatMap(s => s.english_definitions).join('; ');
          const parts_of_speech = entry.senses[0]?.parts_of_speech[0] || '';
          // L·∫•y slug c·ªßa c√°c entry c√≤n l·∫°i
          const see_also = data.data.slice(1).map(e => e.slug).filter(Boolean).join(', ');
          jpwordResults.unshift({words, readings, jlpt, english_definitions, parts_of_speech, see_also, note: ''});
          renderJPWordTable();
          saveJPDictToLocal();
          document.getElementById('jpwordForm').reset();
          document.getElementById('jpwordInput').focus();
          statusDiv.innerHTML = '';
        })
        .catch(() => {
          statusDiv.innerHTML = '<div class="text-danger">L·ªói khi tra c·ª©u!</div>';
        });
      return false;
    }

    function renderJPWordTable() {
      const resultDiv = document.getElementById('jpwordResult');
      if (jpwordResults.length === 0) {
        resultDiv.innerHTML = '';
        return;
      }
      let html = `<div class="table-responsive"><table class="table table-bordered table-sm align-middle text-center">
        <thead>
          <tr class="jpdict-header">
            <th class="text-center align-middle">#</th>
            <th class="text-center align-middle">${t('jpdict_word')}</th>
            <th class="text-center align-middle">${t('jpdict_reading')}</th>
            <th class="text-center align-middle">${t('jpdict_jlpt')}</th>
            <th class="text-center align-middle">${t('jpdict_english')}</th>
            <th class="text-center align-middle">${t('jpdict_type')}</th>
            <th class="text-center align-middle">${t('jpdict_seealso')}</th>
            <th class="text-center align-middle">${t('jpdict_note')}</th>
            <th class="text-center align-middle">${t('jpdict_actions')}</th>
          </tr>
        </thead><tbody>`;
      // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm
      const searchVal = document.getElementById('jpdictSearchInput')?.value.trim().toLowerCase();
      let filtered = jpwordResults;
      if (searchVal) {
        filtered = jpwordResults.filter(row =>
          (row.words && row.words.toLowerCase().includes(searchVal)) ||
          (row.readings && row.readings.toLowerCase().includes(searchVal)) ||
          (row.jlpt && row.jlpt.toLowerCase().includes(searchVal)) ||
          (row.english_definitions && row.english_definitions.toLowerCase().includes(searchVal)) ||
          (row.parts_of_speech && row.parts_of_speech.toLowerCase().includes(searchVal)) ||
          (row.see_also && row.see_also.toLowerCase().includes(searchVal)) ||
          (row.note && row.note.toLowerCase().includes(searchVal))
        );
      }
      for (let i = 0; i < filtered.length; i++) {
        const row = filtered[i];
        const realIdx = jpwordResults.indexOf(row);
        if (jpwordEditIdx === realIdx) {
          html += `<tr>
            <td>${i + 1}</td>
            <td><input class="form-control form-control-sm fw-bold" value="${escapeHTML(row.words)}" id="editJPWord${i}_words"></td>
            <td><input class="form-control form-control-sm" value="${escapeHTML(row.readings)}" id="editJPWord${i}_readings"></td>
            <td><input class="form-control form-control-sm" value="${escapeHTML(row.jlpt)}" id="editJPWord${i}_jlpt"></td>
            <td><input class="form-control form-control-sm" value="${escapeHTML(row.english_definitions)}" id="editJPWord${i}_english_definitions"></td>
            <td><input class="form-control form-control-sm" value="${escapeHTML(row.parts_of_speech)}" id="editJPWord${i}_parts_of_speech"></td>
            <td><input class="form-control form-control-sm" value="${escapeHTML(row.see_also)}" id="editJPWord${i}_see_also"></td>
            <td><input class="form-control form-control-sm" value="${escapeHTML(row.note||'')}" id="editJPWord${i}_note"></td>
            <td class="d-flex gap-1 justify-content-center">
              <button class="btn btn-success btn-sm me-1" onclick="saveEditJPWord(${i})">${t('jpdict_saveedit')}</button>
              <button class="btn btn-secondary btn-sm" onclick="cancelEditJPWord()">${t('jpdict_cancel')}</button>
            </td>
          </tr>`;
        } else {
          html += `<tr>
            <td>${jpwordResults.indexOf(row) + 1}</td>
            <td><b>${row.words ? row.words : '-'}</b></td>
            <td>${row.readings ? row.readings : '-'}</td>
            <td>${row.jlpt ? row.jlpt : '-'}</td>
            <td class="text-start">${row.english_definitions ? row.english_definitions : '-'}</td>
            <td>${row.parts_of_speech ? row.parts_of_speech : '-'}</td>
            <td>${row.see_also ? row.see_also : '-'}</td>
            <td>${row.note ? row.note : '-'}</td>
            <td class="d-flex gap-1 justify-content-center">
              <button class="btn btn-info btn-sm" onclick="editJPWord(${jpwordResults.indexOf(row)})">${t('jpdict_edit')}</button>
              <button class="btn btn-danger btn-sm" onclick="deleteJPWord(${jpwordResults.indexOf(row)})">${t('jpdict_delete')}</button>
            </td>
          </tr>`;
        }
      }
      html += '</tbody></table></div>';
      resultDiv.innerHTML = html;
    }

    function saveJPDictToFile() {
      const blob = new Blob([JSON.stringify(jpwordResults, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hclinh-jpdict.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadJPDictFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            jpwordResults = data;
            renderJPWordTable();
            saveJPDictToLocal();
          } else {
            alert('File kh√¥ng h·ª£p l·ªá!');
          }
        } catch {
          alert('File kh√¥ng h·ª£p l·ªá!');
        }
      };
      reader.readAsText(file);
    }

    function deleteJPWord(idx) {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° t·ª´ n√†y?')) {
        jpwordResults.splice(idx, 1);
        renderJPWordTable();
        saveJPDictToLocal();
      }
    }

    function editJPWord(idx) {
      jpwordEditIdx = idx;
      renderJPWordTable();
    }

    function cancelEditJPWord() {
      jpwordEditIdx = null;
      renderJPWordTable();
    }

    function saveEditJPWord(idx) {
      const get = id => document.getElementById(`editJPWord${idx}_`+id).value;
      jpwordResults[idx] = {
        words: get('words'),
        readings: get('readings'),
        jlpt: get('jlpt'),
        english_definitions: get('english_definitions'),
        parts_of_speech: get('parts_of_speech'),
        see_also: get('see_also'),
        note: get('note')
      };
      jpwordEditIdx = null;
      renderJPWordTable();
      saveJPDictToLocal();
    }

    function saveJPDictToLocal() {
      localStorage.setItem('jpwordResults', JSON.stringify(jpwordResults));
    }

    // Load jpwordResults t·ª´ localStorage khi kh·ªüi t·∫°o
    if(localStorage.getItem('jpwordResults')) {
      jpwordResults = JSON.parse(localStorage.getItem('jpwordResults'));
    }
    renderJPWordTable();
  </script>
</body>
</html> 
